From 3a415d5f67244e41acd6215057d613472d681751 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=C3=8Dcaro=20Hoff?= <icarohoff@gmail.com>
Date: Fri, 4 May 2018 15:48:49 -0300
Subject: [PATCH] Adjust updater URL to Heroku front-end deployment app (v2)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

In the front-end web app, the update 'id' is a 6-digit random number
instead of string as we don't have many updates to handle and it's
cleaner to read in this case.

Change-Id: Ieb89cefff3b34156891a7ac7e571db2e290a8f88
Signed-off-by: √çcaro Hoff <icarohoff@gmail.com>
---
 README.md                                     | 4 ++--
 res/values/strings.xml                        | 3 +--
 src/org/lineageos/updater/misc/Constants.java | 1 -
 src/org/lineageos/updater/misc/Utils.java     | 6 ++----
 4 files changed, 5 insertions(+), 9 deletions(-)

diff --git a/README.md b/README.md
index ecb06f4..6215e70 100644
--- a/README.md
+++ b/README.md
@@ -14,7 +14,7 @@ a JSON with the following structure:
     {
       "datetime": 1230764400,
       "filename": "ota-package.zip",
-      "id": "5eb63bbbe01eeed093cb22bb8f5acdc3",
+      "id": 283787,
       "romtype": "nightly",
       "size": 314572800,
       "url": "https://example.com/ota-package.zip",
@@ -26,7 +26,7 @@ a JSON with the following structure:
 
 The `datetime` attribute is the build date expressed as UNIX timestamp.  
 The `filename` attribute is the name of the file to be downloaded.  
-The `id` attribute is a string that uniquely identifies the update.  
+The `id` attribute is a random number that uniquely identifies the update.  
 The `romtype` attribute is the string to be compared with the `ro.lineage.releasetype` property.  
 The `size` attribute is the size of the update expressed in bytes.  
 The `url` attribute is the URL of the file to be downloaded.  
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 1ca8c83..2c17407 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -30,9 +30,8 @@
         Optional placeholders replaced at runtime:
           {device} - Device name
           {type} - Build type
-          {incr} - Incremental version
     -->
-    <string name="updater_server_url" translatable="false">https://download.lineageos.org/api/v1/{device}/{type}/{incr}</string>
+    <string name="updater_server_url" translatable="false">https://json-lineage-v2.herokuapp.com/api/v1/{device}/{type}</string>
 
     <string name="verification_failed_notification">Verification failed</string>
     <string name="verifying_download_notification">Verifying update</string>
diff --git a/src/org/lineageos/updater/misc/Constants.java b/src/org/lineageos/updater/misc/Constants.java
index 49106d4..672bf73 100644
--- a/src/org/lineageos/updater/misc/Constants.java
+++ b/src/org/lineageos/updater/misc/Constants.java
@@ -33,7 +33,6 @@ public final class Constants {
 
     public static final String PROP_BUILD_DATE = "ro.build.date.utc";
     public static final String PROP_BUILD_VERSION = "ro.lineage.build.version";
-    public static final String PROP_BUILD_VERSION_INCREMENTAL = "ro.build.version.incremental";
     public static final String PROP_DEVICE = "ro.lineage.device";
     public static final String PROP_NEXT_DEVICE = "ro.updater.next_device";
     public static final String PROP_RELEASE_TYPE = "ro.lineage.releasetype";
diff --git a/src/org/lineageos/updater/misc/Utils.java b/src/org/lineageos/updater/misc/Utils.java
index 67895da..d40450e 100644
--- a/src/org/lineageos/updater/misc/Utils.java
+++ b/src/org/lineageos/updater/misc/Utils.java
@@ -85,7 +85,7 @@ public class Utils {
         Update update = new Update();
         update.setTimestamp(object.getLong("datetime"));
         update.setName(object.getString("filename"));
-        update.setDownloadId(object.getString("id"));
+        update.setDownloadId(object.getLong("id"));
         update.setType(object.getString("romtype"));
         update.setFileSize(object.getLong("size"));
         update.setDownloadUrl(object.getString("url"));
@@ -144,7 +144,6 @@ public class Utils {
     }
 
     public static String getServerURL(Context context) {
-        String incrementalVersion = SystemProperties.get(Constants.PROP_BUILD_VERSION_INCREMENTAL);
         String device = SystemProperties.get(Constants.PROP_NEXT_DEVICE,
                 SystemProperties.get(Constants.PROP_DEVICE));
         String type = SystemProperties.get(Constants.PROP_RELEASE_TYPE).toLowerCase(Locale.ROOT);
@@ -155,8 +154,7 @@ public class Utils {
         }
 
         return serverUrl.replace("{device}", device)
-                .replace("{type}", type)
-                .replace("{incr}", incrementalVersion);
+                .replace("{type}", type);
     }
 
     public static String getChangelogURL(Context context) {
-- 
2.17.0

